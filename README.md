# MixVRT
MixVRT(Mix Visual Regression Test)は、Webページのレイアウトの不具合箇所の発見にかかる時間の削減を目的として、
Webページのレイアウト不具合箇所を強調表示する視覚的回帰テストツールである。

## 各種バージョン(記載時点 2024.2.19)
- Python 3.9
- Flask 2.0.1
- Werkzeug 2.0.1

## 環境構築
1. このリポジトリをクローン
2. クローンしたリポジトリのディレクトリに移動する
3. $ docker-compose build をコマンドライン上で打つ
4. $ docker-compose up -d をコマンドライン上で打つ
5. "MixVRT使用時の流れ"(2つ先の節で後述)に従う

## MixVRT の機能
MixVRT は、以下の3つを強調表示する機能を持つ。
- **差分箇所：**  
  変更前後のWebページの画像を比較して、変更前のWebページから削除された範囲と、変更後のWebページに追加された範囲。

- **変更箇所：**  
  変更前後のWebページのHTMLコードを比較して、HTMLコードにおけるbody要素内の変更とstyle要素内の変更のどちらか、または両方が適用された画面要素の範囲。本研究では、変更箇所を意図したレイアウトの差分の範囲とみなす。

- **レイアウトの不具合箇所：**  
  差分箇所から、意図したレイアウトの差分の範囲であるHTMLコードの変更箇所を除いた、意図しないレイアウトの差分の範囲。

## MixVRT使用時の流れ
Webページを作成している開発者がMixVRT を使用する際の流れを、以下に示す。
1. コマンドライン上で`$ make test URL="WebページのURL"`を実行し、初期設定(次の節で後述)を行う。
2. WebページのHTMLコードの変更を行う。
3. コマンドライン上で`$ make test URL="WebページのURL"`を実行し、視覚的回帰テストを実行する。
4. Webブラウザ上で`http://localhost:5000/MixVRT_diff`にアクセスし、テスト結果を確認する。
5. テスト結果を評価する
   - 問題なし：`$ make save`を実行し、変更後画像と変更後HTMLコードで、それぞれ変更前画像と変更前HTMLコードを更新する。
   - 問題あり：変更前、または、変更後のWebページのHTMLコードを修正し、3.に戻る。

## 初期設定
開発者は、MixVRT による視覚的回帰テストを実行するために初期設定を行う必要がある。
初期設定は、Python3.9.17が動作するコマンドライン上で、
以下のMixVRT の実行コマンドを実行することで行える。
```
    $ make test URL="WebページのURL"
```
この初期設定により、視覚的回帰テストを実行するための変更前画像と変更前HTMLコードをbase\_dirディレクトリに保持する。
2回目以降の実行は、変更後画像と変更後HTMLコードをデータ管理部のbase\_dirディレクトリに保持し、
変更前画像と変更後画像との比較、変更前HTMLコードと変更後HTMLコードとの比較を行い、視覚的回帰テストを実行する。

## 入出力
初期設定を行った開発者は、
テスト対象とするWebページのURLを入力としてMixVRT の実行コマンドを実行することで、
MixVRT による視覚的回帰テストを実行できる。
視覚的回帰テストの実行後、MixVRT は、以下に示す8つのPNG形式の画像を生成する。
- **変更前画像：** Webページの変更前画像
- **変更後画像：** Webページの変更後画像
- **差分箇所変更前画像：** 変更により削除された範囲を、赤枠で囲むことで強調表示した、Webページの変更前画像
- **差分箇所変更後画像：** 変更により追加された範囲を、緑枠で囲むことで強調表示した、Webページの変更後画像
- **変更箇所変更前画像：** 変更により削除された画面要素の範囲を、赤枠で囲むことで強調表示した、Webページの変更前画像
- **変更箇所変更後画像：** 変更により追加された画面要素の範囲を、緑枠で囲むことで強調表示した、Webページの変更後画像
- **不具合箇所変更前画像：** レイアウトの不具合箇所のうち、HTMLコードに基づいて削除されていない範囲を、赤枠で囲むことで強調表示した、Webページの変更前画像
- **不具合箇所変更後画像：** レイアウトの不具合箇所のうち、HTMLコードに基づいて追加されていない範囲を、緑枠で囲むことで強調表示した、Webページの変更後画像

MixVRT は、Flaskを用いて構築したローカルサーバ上で動作するWebページに、生成した8つの画像を出力し、表示する。
なお、ローカルサーバは、MixVRT の環境構築の際に自動で起動する。
開発者は、以下のローカルサーバ上のWebページにアクセスすることで、MixVRT が生成した8つの画像を確認できる。
```
    http://localhost:5000/MixVRT_dif
```
なお、MixVRT の初期設定時は、変更後画像と変更後HTMLコードが存在せず視覚的回帰テストを行えないため、Webページの変更前画像のみを確認できる。

## 変更前画像と変更前HTMLコードの更新
MixVRT を用いて変更前後の比較を行い、Webページの更新に問題がないと判断した場合、開発者は下記の実行コマンドを実行する。
これにより、変更後画像と変更後HTMLコードで、それぞれ変更前画像と変更前HTMLコードを更新する。
```
    $ make save
```

## MixVRT の外観
MixVRT のユーザインタフェースは、以下に示す4つのタブを持つタブメニューと、各タブに対応するタブコンテンツからなる。
- **タブメニュー**
  - オリジナル表示
  - 画像比較に基づく差分箇所表示
  - HTMLコードの変更に基づく変更箇所表示
  - レイアウトの不具合箇所表示
- **タブコンテンツ**

下記に、各タブを選択した際に表示するタブコンテンツの外観について説明する。
### オリジナル表示
オリジナル表示は、「変更前画像」と「変更後画像」を左右に並べて表示する。
なお、MixVRT の初回起動時や変更時は、初期画面として、オリジナル表示を表示する。
ここでは、Webページの変更前後の画像を確認できる。

### 画像比較に基づく差分箇所表示
画像比較に基づく差分箇所表示は、「差分箇所変更前画像」と「差分箇所変更後画像」を左右に並べて表示する。
削除された範囲は変更前画像上に赤枠で囲むことで強調表示し、追加された範囲は変更後画像上に緑枠で囲むことで強調表示する。
ここでは、変更前後のWebページでレイアウトの差分箇所が生じた範囲を確認できる。

### HTMLコードの変更に基づく変更箇所表示
HTMLコードの変更に基づく変更箇所表示は、「変更箇所変更前画像」と「変更箇所変更後画像」を左右に並べて表示する。
削除された画面要素の範囲は変更前画像上に赤枠で囲むことで強調表示し、追加された画面要素の範囲は変更後画像上に緑枠で囲むことで強調表示する。
ここでは、差分箇所から、開発者が変更したHTMLコードに基づく変更箇所のみを確認できる。

### レイアウトの不具合箇所表示
レイアウトの不具合箇所表示は、「不具合箇所変更前画像」と「不具合箇所変更後画像」を左右に並べて表示する。
